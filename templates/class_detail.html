{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill"></i> Class: {{ class_name }}</h2>
    <div>
        <a href="{{ url_for('generate_encodings_route', class_name=class_name) }}" class="btn btn-warning me-2">
            <i class="bi bi-gear-fill"></i> Generate Encodings
        </a>
        <a href="{{ url_for('add_data') }}" class="btn btn-outline-secondary">Back to Classes</a>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Manage Students</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_students_route', class_name=class_name) }}" method="post" enctype="multipart/form-data" id="studentForm">
            <div class="table-responsive">
                <table class="table table-bordered" id="studentsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Photos</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in class_data.students %}
                        <tr class="existing-student">
                            <td>
                                <input type="text" class="form-control" name="student_{{ loop.index0 }}_id" 
                                       value="{{ student.student_id }}" required readonly>
                                <small class="text-muted">Cannot change ID</small>
                            </td>
                            <td>
                                <input type="text" class="form-control" name="student_{{ loop.index0 }}_name" 
                                       value="{{ student.name }}" required>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if student.photos %}
                                    <span class="badge bg-info me-2">
                                        {{ student.photos|length }} photo(s)
                                    </span>
                                    {% endif %}
                                    <input type="file" class="form-control" 
                                           name="student_{{ loop.index0 }}_photos" 
                                           accept="image/*" multiple>
                                    <small class="text-muted ms-2">Select one or more photos</small>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger remove-row">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% for i in range(class_data.students|length, class_data.students|length + empty_rows) %}
                        <tr>
                            <td>
                                <input type="text" class="form-control" name="student_{{ i }}_id" placeholder="S001">
                            </td>
                            <td>
                                <input type="text" class="form-control" name="student_{{ i }}_name" placeholder="Full Name">
                            </td>
                            <td>
                                <input type="file" class="form-control" 
                                       name="student_{{ i }}_photos" 
                                       accept="image/*" multiple>
                                <small class="text-muted">Select one or more photos</small>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger remove-row">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-success" id="addRow">
                    <i class="bi bi-plus-circle"></i> Add Row
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Existing Students ({{ class_data.students|length }})</h5>
    </div>
    <div class="card-body">
        {% if class_data.students %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Photos</th>
                        <th>Encodings</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in class_data.students %}
                    <tr>
                        <td>{{ student.student_id }}</td>
                        <td>{{ student.name }}</td>
                        <td>{{ student.photos|length }} photos</td>
                        <td>{{ student.encodings|length }} encodings</td>
                        <td>
                            <form method="post" 
                                  action="{{ url_for('delete_student_route', class_name=class_name, student_id=student.student_id) }}" 
                                  style="display:inline"
                                  onsubmit="return confirm('Delete {{ student.name }} ({{ student.student_id }}) permanently?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="bi bi-emoji-frown display-4"></i>
            <p class="mt-2">No students added yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Class Report Button Added Here -->
<div class="d-flex justify-content-end mt-4">
    <a href="{{ url_for('class_report', class_name=class_name) }}" class="btn btn-dark">
        <i class="bi bi-bar-chart-line"></i> Class Report
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let rowCount = {{ (class_data.students|length + empty_rows)|int }};
    
    // Add new row
    document.getElementById('addRow').addEventListener('click', function() {
        const table = document.getElementById('studentsTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        
        const newRow = tbody.rows[0].cloneNode(true);
        
        // Clear input values
        const inputs = newRow.getElementsByTagName('input');
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].type !== 'file') {
                inputs[i].value = '';
            } else {
                inputs[i].value = '';
            }
            // Update names to use the new rowCount
            if (inputs[i].name) {
                const parts = inputs[i].name.split('_');
                if (parts.length >= 3) {
                    inputs[i].name = `student_${rowCount}_${parts[2]}`;
                }
            }
        }
        
        // Remove readonly attribute from ID field for new rows
        const idInput = newRow.querySelector('input[name$="_id"]');
        if (idInput) {
            idInput.readOnly = false;
            idInput.placeholder = "S001";
            
            // Remove the "Cannot change ID" message
            const smallText = newRow.querySelector('small.text-muted');
            if (smallText) {
                smallText.remove();
            }
        }
        
        // Enable remove button
        const removeBtn = newRow.querySelector('.remove-row');
        removeBtn.disabled = false;
        
        tbody.appendChild(newRow);
        rowCount++;
    });
    
    // Remove row
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-row') || 
            e.target.parentElement.classList.contains('remove-row')) {
            const btn = e.target.classList.contains('remove-row') ? 
                       e.target : e.target.parentElement;
            const row = btn.closest('tr');
            
            // Don't remove rows that are the only existing student row
            const existingRows = document.querySelectorAll('.existing-student');
            if (row.classList.contains('existing-student') && existingRows.length <= 1) {
                alert("You cannot remove the only existing student.");
                return;
            }
            
            if (row && row.parentElement.rows.length > 1) {
                row.remove();
            }
        }
    });
});
</script>
{% endblock %}
